!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).xRequest={})}(this,(function(t){"use strict";function e(t,e){return Object.prototype.toString.call(t).substr(8,e.length).toLowerCase()===e}function o(t){return e(t,"object")}function n(t){return e(t,"undefined")}var r=/\{(\w+)\}/g;function s(t){return e(t,"function")}function i(t,e,n){n=n||this;var r,i=s(e);if(r=t,Array.isArray(r))for(var a=0;a<t.length;a++){var u=!0;if(i&&(u=e.call(n,t[a],a)),!1===u)break}else if(o(t))for(var c=Object.keys(t),f=0;f<c.length;f++){var p=!0;if(i&&(p=e.call(n,t[c[f]],c[f])),!1===p)break}}function a(t){for(var e,n,r=arguments,s=[],i=arguments.length-1;i-- >0;)s[i]=r[i+1];if(!s.length)return t;var u=s.shift();if(o(t)&&o(u))for(var c in u)o(u[c])?(t[c]||Object.assign(t,((e={})[c]={},e)),a(t[c],u[c])):Object.assign(t,((n={})[c]=u[c],n));return a.apply(void 0,[t].concat(s))}function u(t){return e(t,"string")}var c,f=function(t){function e(e,o){t.call(this,e,{cause:o}),this.code=-1,this.name="RequestError",this.code=o}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),p=function(t){return t},h=!1,d={},l={},v=1,y=/get|head|delete/,g=/^http[s]?:/i,m=/^\//i,k={},w=function(t){var e=window.location.pathname;if(k[e]&&k[e].length){var o=k[e].indexOf(t);-1!==o&&k[e].splice(o,1)}};function R(t,e){var n=t;return t=(t=d[t])||n,o(e)&&(t=t.replace(r,(function(t,o){var n=e[o];return delete e[o],n}))),t}var b=console,O=!0;function j(){for(var t,e=[],o=arguments.length;o--;)e[o]=arguments[o];t=O?["%c[Request]","color: cyan;"].concat(e):e,b.log.apply(b,t)}var q=function(){this.defConf={autoToast:!0,dataType:"json",fresh:!0,credentials:!1,header:{"X-Requested-With":"XMLHttpRequest"},timeout:1e4,raw:!1},this.hooks={},this.keys={data:"data",code:"code",message:"message"};this.hooks={onRequest:function(t,e,o){},onResponse:function(t){return t},onResponseError:function(t){return!0}}};q.register=function(t,e){o(t)&&i(t,(function(t,s){var i,a;d[s]?console.warn("API "+s+" 已被定义"):(m.test(s)||(s="/"+s),u(e)&&!g.test(t)?(m.test(t)||(t="/"+t),t=""+e+t):g.test(t)||(i=l,void 0===(a=!0)&&(a=!1),t=t.replace(r,(function(t,e){var r=o(i)?i[e]:i;return n(r)&&a?t:r}))),d[s]=t)}))},q.cancel=function(t){var e=u(t)?t:window.location.pathname,o=k[e];if(o&&o.length)try{for(var n in o){var r=o[n];r&&r.abort()}}catch(t){console.error(t)}k[e]=[]},q.randomStr=function(){return(Date.now()+Math.random()).toString(16)},q.prototype.resolveUri=function(t,e){return R(t,e)},q.prototype.parseData=function(t){return u(t)?t.replace(/\+/g,"%2B"):JSON.stringify(t)},q.prototype.parseFormData=function(t){var e=new FormData;return o(t)&&i(t,(function(t,o){e.append(o,t)})),e},q.prototype.checkOriginHost=function(t){return q.A.href=t,q.A.host===window.location.host},q.prototype.setting=function(t){o(t)&&(h&&j("setting","->",t),o(t.hooks)&&(this.hooks=a(this.hooks,t.hooks)),o(t.keys)&&(this.keys=a(this.keys,t.keys)))},q.prototype.run=function(t,n,r,u,h){var d=this;void 0===r&&(r={}),void 0===u&&(u={}),void 0===h&&(h={}),t=t.toLocaleLowerCase();var l,g=a(this.defConf,h);g.fresh&&(r._=q.randomStr()),s(this.hooks.onRequest)&&this.hooks.onRequest.call(this,g,r,u),n=this.resolveUri(n,r),o(r)&&(n+=(-1!==n.indexOf("?")?"&":"?")+((l=r)?Object.keys(l).map((function(t){return t+"="+encodeURIComponent(l[t])})).join("&"):""));var m,R,b=new XMLHttpRequest,O=new Promise((function(o,a){var l,m,k=g.header,R=!d.checkOriginHost(n);y.test(t)||(k.hasOwnProperty("Content-Type")||(k["Content-Type"]="application/json"),null===k["Content-Type"]?(delete k["Content-Type"],l=d.parseFormData(u)):l=d.parseData(u)),R&&(h.credentials&&(b.withCredentials=!0),delete k["X-Requested-With"]),m=h.timeout,!isNaN(m)&&e(m,"number")&&(b.timeout=h.timeout),b.open(t,n,!0),i(k,(function(t,e){b.setRequestHeader(e,t)}));var O=d;b.onload=function(){if(w(this),this.status>=200&&this.status<300||304===this.status){var t=this.responseText;if(s(O.hooks.onResponse)&&O.hooks.onResponse.call(O,t,h,r,l),"json"===g.dataType)try{t=JSON.parse(t)}catch(t){return void a(t)}var e=t[O.keys.data],n=t[O.keys.code];if(Number(n)!==v){var i=t[O.keys.message];return g.autoToast&&i&&c&&c(p({description:i,message:"请求错误",type:"fail"})),O.hooks.onResponseError(t,"Business",g),a(t)}o(h.raw?t:e||{})}else a(new f(this.status+" Error",this.status))},b.onerror=function(){O.hooks.onResponseError({},"Net",g),a(new f("Net Error, ["+t+"] >> "+n,this.status))},b.ontimeout=b.onerror=function(){w(this),O.hooks.onResponseError({},"Timeout",g),a(new f("Request timeout, ["+t+"] >> "+n,this.status))},b.send(l)}));return O.abort=function(){b.abort(),w(b)},m=b,R=window.location.pathname,k[R]||(k[R]=[]),k[R].push(m),O},q.prototype.get=function(t,e,o){return this.run("GET",t,e,{},o)},q.prototype.post=function(t,e,r,s){return o(e)&&n(r)&&(r=e,e={}),n(r)&&(r={}),this.run("POST",t,e,r,s)},q.A=document.createElement("a");var T=new q;t.R=q,t.config=function(t,e){void 0===e&&(e="production"),h="production"!==e;var r=t.successCode,a=t.hosts,u=t.apis,f=t.notifyMod,d=t.notifyMsgFormater,y=t.logger;n(r)||(v=r),o(a)&&i(a,(function(t,e){l[e]=t})),o(u)&&q.register(u),n(f)||(c=f),s(d)&&(p=d),y&&s(y.log)&&(O=!1,b=y),h&&j("config","->",t)},t.default=T,t.resloveUrl=R,Object.defineProperty(t,"__esModule",{value:!0})}));
