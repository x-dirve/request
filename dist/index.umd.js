!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).xRequest={})}(this,(function(t){"use strict";function e(t,e){return Object.prototype.toString.call(t).substr(8,e.length).toLowerCase()===e}function n(t){return e(t,"object")}function o(t){return e(t,"undefined")}var r,s=/\{(\w+)\}/g;function i(t){return e(t,"function")}function a(t,e,o){o=o||this;var r,s=i(e);if(r=t,Array.isArray(r))for(var a=0;a<t.length;a++){var u=!0;if(s&&(u=e.call(o,t[a],a)),!1===u)break}else if(n(t))for(var c=Object.keys(t),f=0;f<c.length;f++){var p=!0;if(s&&(p=e.call(o,t[c[f]],c[f])),!1===p)break}}function u(t){for(var e,o,r=arguments,s=[],i=arguments.length-1;i-- >0;)s[i]=r[i+1];if(!s.length)return t;var a=s.shift();if(n(t)&&n(a))for(var c in a)n(a[c])?(t[c]||Object.assign(t,((e={})[c]={},e)),u(t[c],a[c])):Object.assign(t,((o={})[c]=a[c],o));return u.apply(void 0,[t].concat(s))}function c(t){return e(t,"string")}var f=function(t){return t},p={},h={},l=1,d=/get|head|delete/,v=/^http[s]?:/i,y=/^\//i,g={},m=function(t){var e=window.location.pathname;if(g[e]&&g[e].length){var n=g[e].indexOf(t);-1!==n&&g[e].splice(n,1)}};function k(t,e){var o=t;return t=(t=p[t])||o,n(e)&&(t=t.replace(s,(function(t,n){var o=e[n];return delete e[n],o}))),t}function w(){for(var t,e=[],n=arguments.length;n--;)e[n]=arguments[n];(t=console.log).call.apply(t,[console,"%c[Request]","color: cyan;"].concat(e))}var R=function(){this.defConf={autoToast:!0,dataType:"json",fresh:!0,credentials:!1,header:{"X-Requested-With":"XMLHttpRequest"},timeout:1e4,raw:!1},this.hooks={},this.keys={data:"data",code:"code",message:"message"};this.hooks={onRequest:function(t,e,n){},onResponse:function(t){return t},onResponseError:function(t){return!0}}};R.register=function(t,e){n(t)&&a(t,(function(t,r){var i,a;p[r]?console.warn("API "+r+" 已被定义"):(y.test(r)||(r="/"+r),c(e)&&!v.test(t)?(y.test(t)||(t="/"+t),t=""+e+t):v.test(t)||(i=h,void 0===(a=!0)&&(a=!1),t=t.replace(s,(function(t,e){var r=n(i)?i[e]:i;return o(r)&&a?t:r}))),p[r]=t)}))},R.cancel=function(){var t=window.location.pathname,e=g[t];if(e&&e.length)try{for(var n in e){var o=e[n];o&&o.abort()}}catch(t){console.error(t)}g[t]=[]},R.randomStr=function(){return(Date.now()+Math.random()).toString(16)},R.prototype.resolveUri=function(t,e){return k(t,e)},R.prototype.parseData=function(t){return c(t)?t.replace(/\+/g,"%2B"):JSON.stringify(t)},R.prototype.parseFormData=function(t){var e=new FormData;return n(t)&&a(t,(function(t,n){e.append(n,t)})),e},R.prototype.checkOriginHost=function(t){return R.A.href=t,R.A.host===window.location.host},R.prototype.setting=function(t){n(t)&&(w("setting","->",t),n(t.hooks)&&(this.hooks=u(this.hooks,t.hooks)),n(t.keys)&&(this.keys=u(this.keys,t.keys)))},R.prototype.run=function(t,e,o,s,c){var p=this;void 0===o&&(o={}),void 0===s&&(s={}),void 0===c&&(c={}),t=t.toLocaleLowerCase();var h,v=u(this.defConf,c);v.fresh&&(o._=R.randomStr()),i(this.hooks.onRequest)&&this.hooks.onRequest.call(this,v,o,s),e=this.resolveUri(e,o),n(o)&&(e+="?"+((h=o)?Object.keys(h).map((function(t){return t+"="+encodeURIComponent(h[t])})).join("&"):""));var y,k,w=new XMLHttpRequest,b=new Promise((function(n,o){var u,h=v.header,y=!p.checkOriginHost(e);d.test(t)||(h.hasOwnProperty("Content-Type")||(h["Content-Type"]="application/json"),null===h["Content-Type"]?(delete h["Content-Type"],u=p.parseFormData(s)):u=p.parseData(s)),y&&(c.credentials&&(w.withCredentials=!0),delete h["X-Requested-With"]),c.timeout&&(w.timeout=c.timeout),w.open(t,e,!0),a(h,(function(t,e){w.setRequestHeader(e,t)}));var g=p;w.onload=function(){if(m(this),this.status>=200&&this.status<300||304===this.status){var t=this.responseText;if(i(g.hooks.onResponse)&&g.hooks.onResponse.call(g,t),"json"===v.dataType)try{t=JSON.parse(t)}catch(t){return void o(t)}var e=t[g.keys.data],s=t[g.keys.code];if(Number(s)!==l){var a=t[g.keys.message];return v.autoToast&&a&&r&&r(f({description:a,message:"请求错误",type:"fail"})),g.hooks.onResponseError(t),o(t)}n(c.raw?t:e||{})}else o(new Error("Request Error, status ["+this.status+"]"))},w.ontimeout=w.onerror=function(t){m(this),o(t)},w.send(u)}));return b.abort=function(){w.abort(),m(w)},y=w,k=window.location.pathname,g[k]||(g[k]=[]),g[k].push(y),b},R.prototype.get=function(t,e,n){return this.run("GET",t,e,{},n)},R.prototype.post=function(t,e,r,s){return n(e)&&o(r)&&(r=e,e={}),o(r)&&(r={}),this.run("POST",t,e,r,s)},R.A=document.createElement("a");var b=new R;t.R=R,t.config=function(t){var e=t.successCode,s=t.hosts,u=t.apis,c=t.notifyMod,p=t.notifyMsgFormater;w("config","->",t),o(e)||(l=e),n(s)&&a(s,(function(t,e){h[e]=t})),n(u)&&R.register(u),o(c)||(r=c),i(p)&&(f=p)},t.default=b,t.resloveUrl=k,Object.defineProperty(t,"__esModule",{value:!0})}));
