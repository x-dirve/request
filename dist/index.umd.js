!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).xRequest={})}(this,(function(t){"use strict";function e(t,e){return Object.prototype.toString.call(t).substr(8,e.length).toLowerCase()===e}function o(t){return e(t,"object")}function n(t){return e(t,"undefined")}var r=/\{(\w+)\}/g;function s(t){return e(t,"function")}function i(t,e,n){n=n||this;var r,i=s(e);if(r=t,Array.isArray(r))for(var a=0;a<t.length;a++){var u=!0;if(i&&(u=e.call(n,t[a],a)),!1===u)break}else if(o(t))for(var c=Object.keys(t),f=0;f<c.length;f++){var p=!0;if(i&&(p=e.call(n,t[c[f]],c[f])),!1===p)break}}function a(t){for(var e,n,r=arguments,s=[],i=arguments.length-1;i-- >0;)s[i]=r[i+1];if(!s.length)return t;var u=s.shift();if(o(t)&&o(u))for(var c in u)o(u[c])?(t[c]||Object.assign(t,((e={})[c]={},e)),a(t[c],u[c])):Object.assign(t,((n={})[c]=u[c],n));return a.apply(void 0,[t].concat(s))}function u(t){return e(t,"string")}var c,f=!1,p=function(t){return t},h={},l={},d=1,v=/get|head|delete/,y=/^http[s]?:/i,g=/^\//i,m={},k=function(t){var e=window.location.pathname;if(m[e]&&m[e].length){var o=m[e].indexOf(t);-1!==o&&m[e].splice(o,1)}};function w(t,e){var n=t;return t=(t=h[t])||n,o(e)&&(t=t.replace(r,(function(t,o){var n=e[o];return delete e[o],n}))),t}function R(){for(var t,e=[],o=arguments.length;o--;)e[o]=arguments[o];(t=console.log).call.apply(t,[console,"%c[Request]","color: cyan;"].concat(e))}var b=function(){this.defConf={autoToast:!0,dataType:"json",fresh:!0,credentials:!1,header:{"X-Requested-With":"XMLHttpRequest"},timeout:1e4,raw:!1},this.hooks={},this.keys={data:"data",code:"code",message:"message"};this.hooks={onRequest:function(t,e,o){},onResponse:function(t){return t},onResponseError:function(t){return!0}}};b.register=function(t,e){o(t)&&i(t,(function(t,s){var i,a;h[s]?console.warn("API "+s+" 已被定义"):(g.test(s)||(s="/"+s),u(e)&&!y.test(t)?(g.test(t)||(t="/"+t),t=""+e+t):y.test(t)||(i=l,void 0===(a=!0)&&(a=!1),t=t.replace(r,(function(t,e){var r=o(i)?i[e]:i;return n(r)&&a?t:r}))),h[s]=t)}))},b.cancel=function(){var t=window.location.pathname,e=m[t];if(e&&e.length)try{for(var o in e){var n=e[o];n&&n.abort()}}catch(t){console.error(t)}m[t]=[]},b.randomStr=function(){return(Date.now()+Math.random()).toString(16)},b.prototype.resolveUri=function(t,e){return w(t,e)},b.prototype.parseData=function(t){return u(t)?t.replace(/\+/g,"%2B"):JSON.stringify(t)},b.prototype.parseFormData=function(t){var e=new FormData;return o(t)&&i(t,(function(t,o){e.append(o,t)})),e},b.prototype.checkOriginHost=function(t){return b.A.href=t,b.A.host===window.location.host},b.prototype.setting=function(t){o(t)&&(f&&R("setting","->",t),o(t.hooks)&&(this.hooks=a(this.hooks,t.hooks)),o(t.keys)&&(this.keys=a(this.keys,t.keys)))},b.prototype.run=function(t,e,n,r,u){var f=this;void 0===n&&(n={}),void 0===r&&(r={}),void 0===u&&(u={}),t=t.toLocaleLowerCase();var h,l=a(this.defConf,u);l.fresh&&(n._=b.randomStr()),s(this.hooks.onRequest)&&this.hooks.onRequest.call(this,l,n,r),e=this.resolveUri(e,n),o(n)&&(e+="?"+((h=n)?Object.keys(h).map((function(t){return t+"="+encodeURIComponent(h[t])})).join("&"):""));var y,g,w=new XMLHttpRequest,R=new Promise((function(o,n){var a,h=l.header,y=!f.checkOriginHost(e);v.test(t)||(h.hasOwnProperty("Content-Type")||(h["Content-Type"]="application/json"),null===h["Content-Type"]?(delete h["Content-Type"],a=f.parseFormData(r)):a=f.parseData(r)),y&&(u.credentials&&(w.withCredentials=!0),delete h["X-Requested-With"]),u.timeout&&(w.timeout=u.timeout),w.open(t,e,!0),i(h,(function(t,e){w.setRequestHeader(e,t)}));var g=f;w.onload=function(){if(k(this),this.status>=200&&this.status<300||304===this.status){var t=this.responseText;if(s(g.hooks.onResponse)&&g.hooks.onResponse.call(g,t),"json"===l.dataType)try{t=JSON.parse(t)}catch(t){return void n(t)}var e=t[g.keys.data],r=t[g.keys.code];if(Number(r)!==d){var i=t[g.keys.message];return l.autoToast&&i&&c&&c(p({description:i,message:"请求错误",type:"fail"})),g.hooks.onResponseError(t),n(t)}o(u.raw?t:e||{})}else n(new Error("Request Error, status ["+this.status+"]"))},w.ontimeout=w.onerror=function(t){k(this),n(t)},w.send(a)}));return R.abort=function(){w.abort(),k(w)},y=w,g=window.location.pathname,m[g]||(m[g]=[]),m[g].push(y),R},b.prototype.get=function(t,e,o){return this.run("GET",t,e,{},o)},b.prototype.post=function(t,e,r,s){return o(e)&&n(r)&&(r=e,e={}),n(r)&&(r={}),this.run("POST",t,e,r,s)},b.A=document.createElement("a");var O=new b;t.R=b,t.config=function(t,e){void 0===e&&(e="prod"),f="prod"!==e;var r=t.successCode,a=t.hosts,u=t.apis,h=t.notifyMod,v=t.notifyMsgFormater;f&&R("config","->",t),n(r)||(d=r),o(a)&&i(a,(function(t,e){l[e]=t})),o(u)&&b.register(u),n(h)||(c=h),s(v)&&(p=v)},t.default=O,t.resloveUrl=w,Object.defineProperty(t,"__esModule",{value:!0})}));
